---
title: 加固容器映像
author: 李慧霸
date: 5/25/2017
categories: [中文, image]
tags: [container, image, hyperlayer]
keywords: container, docker, image, block, lvm, hyperlayer
---

容器映像严重依赖文件系统层面尚未稳定的功能，因此我们提议一种块层的映像系统，它与
现有映像系统有着相同设分层设计，但实现在块存储层次（即lvm），而不是文件系统层次。
这个设计所依赖的所有功能均已成熟稳定，达到生产环境的要求，并且都在Linux主线内核
里维护。

<!--more-->

### 容器的映像系统

容器在这个云计算时代变得愈发重要，越来越多的客户对容器产生了兴趣，甚至已经开始使用容器
来分发、部署和运行应用程序。

容器的一个关键优势是其分层映像系统，它利用了aufs、btrfs、overlayfs、zfs、lvm以及
device mapper等存储技术的先进特性。下图是从docker官方网站摘录出来的，它展示了docker
对于各种不同的工作负载提供了许多存储driver选项。然而遗憾的是，它们当中只有lvm这一个选择
同时满足production-ready和进入Linux内核这两项标准。事实上，lvm是官方唯一建议用于
RHEL/CentOS生产环境的存储driver。RHEL/CentOS系列操作系统是生产服务器中最为广泛
使用的Linux发行版，尤其是在大型企业里。

![Storage Drivers](/images/driver-pros-cons.png)

LVM是一种块存储技术，然而docker的分层映像系统是基于文件系统技术设计的，所以他们之间
存在一道语义鸿沟：映像中的每一层都是由被修改的文件以及文件元数据组成，而LVM中的每一层
（快照）是由被修改的数据块组成。为了抹平这一鸿沟，lvm存储驱动需要遍历并对比相邻层次中
的所有文件，并判断每个文件是否修改或新增。这一过程由docker中的`NaiveDiffDriver`类完成。

除此之外，这一设计选择还有一些其他的基础性问题：

1. 文件系统层的功能特性通常实现起来都非常复杂，这就是为什么时至今日所有文件系统层的
driver都还不适用于生产环境；
2. 一些文件系统层面的高级功能无法在现有设计里得到支持，例如扩展属性xattr，因此SELinux
也无法使用；
3. 应用无法自主选择文件系统类型，即便某种特定的文件系统能使应用显著受益；
4. 当映像层数增加，文件系统的元数据访问会越来越慢；
5. 对任何大文件的第一次修改都会有很长的延迟，用来做文件的写时复制（Copy-on-Write），
这将导致I/O性能的显著波动。

### 一种块级别的映像系统

为了解决这些问题，我们提议一种新型的映像系统，基于块存储来设计，可以支持任何类型的文件系统，
以及文件系统的完整功能集合，也可以保障持续、稳定的I/O性能。这一设计基于久经考验的LVM，同时
我们也设计了一个新的工具`lvdiffer`，来创建或应用块层次的patch/diff文件。

设计的patch文件具有简单且可序列化的格式，如下所示：

```
HYPERLAYER/1.0
<key>: <value>
<key>: <value>
<key>: <value>
<key>: <value>

<offset> <length>
<data of $length*512 bytes>
<offset> <length>
<data of $length*512 bytes>
<offset> <length>
<data of $length*512 bytes>
...

```

其中：

1. key和value是该patch文件的属性，由大小写字母、数字和下划线组成，并且首字符不能是数字；
2. offset和length是16进制数字，没有'0x'前缀，以sector为单位（512字节）；
3. offset不需要依照某种特定顺序排列；
4. 换行符是单个'\n'，没有'\r'；

例如：

```
HYPERLAYER/1.0
Parent: 68044d4a72dfcf15018cfa6b4baf89361913d93d
Author: Huiba Li <lihuiba@gmail.com>
Date: Thu May 4 15:34:37 2017 +0800 

0 8
<data of 4096 bytes>
800 80
<data of 65536 bytes>
...
```

这种格式叫做*HyperLayer*，它被设计为一种通用的块存储系统diff/patch格式，可用于（但不限于）
LVM和QCoW2。基于这种patch文件，我们可以实现跟docker类似的基于块存储的映像系统。



